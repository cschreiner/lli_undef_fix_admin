#!/bin/sh
# reduce a csmith-generated .c file to just the seed information needed to
# regenerate the file.
# 
# Correct use:
#   csmith_c_to_seed file1.c...

scriptname=csmith_c_to_seed
CRITICAL_LINES=9
TMPDIR=/tmp/${scriptname}_`date +%Y%b%d_%H%M%S`_$$

handle_one_file()
{
   arg_filename=$1

   tmp_filename=$TMPDIR/`basename $arg_filename`
   head -n$CRITICAL_LINES $arg_filename > $tmp_filename

   if grep -q 'Generator:.*csmith' $tmp_filename; then
      # good, this appears to be a csmith generated file
      dummy=""
   else
      # not a csmith file
      echo ${scriptname}: this file does not appear to be generated by csmith.
      echo "  " file=\"$arg_filename\"
      rm $tmp_filename
      return 127
   fi

   if grep -q 'Seed:' $tmp_filename; then
      # good, this appears to be a csmith generated file
      dummy=""
   else
      # not a csmith file
      echo ${scriptname}: this file does not appear to name a seed.
      echo "  " file=\"$arg_filename\"
      rm $tmp_filename
      return 127
   fi

   rm $arg_filename
   mv $tmp_filename $arg_filename
   return 0
}

# set up
mkdir -p $TMPDIR

for file in "$@"; do
   case "$file" in
      *.c)
	 handle_one_file $file
         ;;
      *)
         echo ${scriptname}: this does not appear to be a .c file:
         echo "  " file=\"$file\"
         exit 127
         ;;
   esac
done

# clean up and exit
rm -rf $TMPDIR

# ==============================================================================
# end of script
