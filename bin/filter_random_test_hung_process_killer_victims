#!/bin/bash
# Takes on stdin a set of files generated by run_csmith_lli or similar, and
# filters for those generated by runs that apparently got killed by the
# program random_test_hung_process_killer. 

scriptname=filter_random_test_hung_process_killer_victims
tmpfile=/tmp/${scriptname}_`date +%Y%b%d_%H%M%S`_${$}_$RANDOM
echo using tmpfile=\"$tmpfile\" #;;

while read runfile; do
   #echo runfile=\"$runfile\"
   run_base=`basename $runfile | \
	 awk '{sub(/_.*/, ""); sub(/\..*/, ""); sub(/\s+/, "\n"); print $0;}' `
   echo $run_base
done < /dev/stdin | sort | uniq > $tmpfile

echo tmpfile:
cat $tmpfile
echo ===

exit 0 #;;

while read runfile; do
   echo runfile=\"$runfile\" #;;
   run_base=`basename $runfile | \
	 awk '{sub(/_.*/, ""); sub(/\..*/, ""); print $0;}' `
   echo $run_base
done < /dev/stdin | sort | uniq > $tmpfile
   
exit 0 #;;


for run_base in `cat $tmpfile`; do
   run_base=`basename $runfile | \
	 awk '{sub(/_.*/, ""); sub(/\..*/, ""); print $0;}' `
   
   run_dir=`dirname $runfile`
   run_0_stderr=$run_dir/${run_base}_o0.ll.stderr
   run_3_stderr=$run_dir/${run_base}_o3.ll.stderr

   grep -qiE '\bkilled\b' $run_0_stderr
   run_0_killed=$?
   grep -qiE '\bkilled\b' $run_3_stderr
   run_3_killed=$?
   run_0_len=`stat --printf="%s\n" $run_0_stderr`
   run_3_len=`stat --printf="%s\n" $run_3_stderr`

   if [ $run_0_killed -eq 0 -a $run_3_len -eq 0 -o \
         $run_3_killed -eq 3 -a -$run_0_len -eq 0 -o \
         $run_0_killed -eq 0 -a $run_3_killed -eq 0 ]; then 
      echo $run_dir/$run_base
    fi
done

rm $tmpfile


