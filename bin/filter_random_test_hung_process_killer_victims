#!/bin/bash
# Takes on stdin a set of files generated by run_csmith_lli or similar, and
# filters for those generated by runs that apparently got killed by the
# program random_test_hung_process_killer. 

for runfile in `cat /dev/stdin`; do
   run_base=`basename $runfile | \
	 awk '{sub(/_.*/, ""); sub(/\..*/, ""); print $0;}' `
   
   run_dir=`dirname $runfile`
   run_0_stderr=$run_dir/${run_base}_o0.ll.stderr
   run_3_stderr=$run_dir/${run_base}_o3.ll.stderr

   grep -qiE '\bkilled\b' $run_0_stderr
   run_0_killed=$?
   grep -qiE '\bkilled\b' $run_3_stderr
   run_3_killed=$?
   run_0_len=`stat --printf="%s\n" $run_0_stderr`
   run_3_len=`stat --printf="%s\n" $run_3_stderr`

   if [ $run_0_killed -eq 0 -a $run_3_len -eq 0 -o \
         $run_3_killed -eq 3 -a -$run_0_len -eq 0 -o \
         $run_0_killed -eq 0 -a $run_3_killed -eq 0 ]; then 
      echo $runfile
    fi
done



