#!/bin/bash
# Run llvm's configure script with customizations necessary for the current
# development host.

scriptname=lli_undef_fix3/admin/bin/configure-llvm
if [ -z "$PROJ_ROOT" ]; then
   echo ${scriptname}: environment variable PROJ_ROOT not set.
   exit 255
fi

# TODO2: consider running `gcc --version`, and if version is 4.6, then
# setting --disable-compiler-version-checks. 

# Note: configure's --disable-compiler-version-checks flag doesn't work with
# gcc4.6 because the build process requires compiler support for C++2011.

BUILD_DIR=`pwd`

# ----------------------------------------------------------------------------
# check the build directory

# is the current directory the intended build directory?
echo configuring to build in this directory:
echo "  " \"$BUILD_DIR\"
echo -n "Is that correct? (Y/n) "
read input
case $input in
   y*|Y*)
      echo continuing...
      ;;
   *)
      echo Please cd to the intended build directory and rerun this script.
      exit 255
      ;;
esac

# is the current directory empty?
if find | grep -vEq -e '^\\s*$'; then
   # all appears to be ok
   echo setting up build directory in $BUILD_DIR.
else
   echo ${scriptname}: current directory would be used 
   echo "  " as the build dir, but it does not appear to be empty.
   exit 255
fi

# ----------------------------------------------------------------------------
# configure the build
$PROJ_ROOT/git/llvm/configure --prefix $PROJ_ROOT/live \
      $host_specific_options "$@"

# ----------------------------------------------------------------------------
# set up stuff derived from the configuration

# lit needs a config-generated file in its test dir hierarchy
ln -s $BUILD_DIR/test/lit.site.cfg $PROJ_ROOT/git/test 

# ----------------------------------------------------------------------------
# end of script

